{"version":3,"file":"ry3H8mcT.js","sources":["../../../../components/account/ChangeMobile.vue"],"sourcesContent":["<template>\r\n  <form @submit.prevent=\"saveMobile\" class=\"bg-white dark:bg-gray-800 shadow rounded-xl max-w-full mx-auto w-full my-4\">\r\n    <div class=\"grid grid-cols-1 md:grid-cols-[250px_1fr] divide-y md:divide-y-0 md:divide-x divide-gray-200 dark:divide-gray-700\">\r\n\r\n      <!-- Title & Description -->\r\n      <div class=\"p-6\">\r\n        <h2 class=\"text-lg font-medium text-gray-900 dark:text-white\">Manage Your Mobile</h2>\r\n        <p class=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\r\n          Update your mobile number and verify it with OTP.\r\n        </p>\r\n      </div>\r\n\r\n      <!-- Mobile Input & OTP -->\r\n      <div class=\"p-4 space-y-6\">\r\n\r\n        <!-- Mobile Input with +91 prefix -->\r\n        <div>\r\n          <label for=\"mobile\" class=\"form-label\">Your Mobile Number</label>\r\n          <div class=\"flex items-center mt-1\">\r\n            <span class=\"px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-r-0 rounded-l-md text-gray-700 dark:text-gray-300\">+91</span>\r\n            <input\r\n                v-model=\"mobile\"\r\n                id=\"mobile\"\r\n                type=\"tel\"\r\n                placeholder=\"9876543210\"\r\n                class=\"w-full flex-1 px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600\r\n                text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 rounded-r-md\"\r\n                @blur=\"onMobileBlur\"\r\n            />\r\n          </div>\r\n          <span v-if=\"fieldError\" class=\"form-error\">{{ fieldError }}</span>\r\n        </div>\r\n\r\n        <!-- Send OTP Button -->\r\n        <div class=\"flex justify-end\" v-if=\"canSendOtp && !otpVerified\">\r\n          <button\r\n              type=\"button\"\r\n              @click=\"sendOtp\"\r\n              :disabled=\"otpSending\"\r\n              class=\"btn-green text-sm px-4 py-2\"\r\n          >\r\n            {{ otpSent ? `Resend OTP (${countdown}s)` : 'Send OTP' }}\r\n          </button>\r\n        </div>\r\n\r\n        <!-- OTP Fields -->\r\n        <div v-if=\"otpSent && !otpVerified\" class=\"flex flex-col items-center w-full\">\r\n          <label class=\"form-label mt-4 text-center\">Enter OTP</label>\r\n          <div class=\"flex justify-center gap-1 mt-2 flex-wrap\">\r\n            <input\r\n                v-for=\"(digit, index) in otp\"\r\n                :key=\"index\"\r\n                maxlength=\"1\"\r\n                type=\"text\"\r\n                inputmode=\"numeric\"\r\n                class=\"otp-input\"\r\n                v-model=\"otp[index]\"\r\n                @input=\"focusNext(index, $event)\"\r\n            />\r\n          </div>\r\n          <span v-if=\"otpError\" class=\"form-error mt-2\">{{ otpError }}</span>\r\n          <button\r\n              type=\"button\"\r\n              @click=\"verifyOtp\"\r\n              class=\"btn-blue mt-4 w-full sm:w-1/2 md:w-1/3\"\r\n              :disabled=\"verifyingOtp || otp.join('').length < 6\"\r\n          >\r\n            {{ verifyingOtp ? 'Verifying...' : 'Verify OTP' }}\r\n          </button>\r\n        </div>\r\n\r\n        <!-- OTP Verified -->\r\n        <div v-if=\"otpVerified\" class=\"text-center mt-4\">\r\n          <p class=\"text-green-600 font-semibold text-sm\">✅ OTP Verified Successfully</p>\r\n          <button\r\n              type=\"submit\"\r\n              class=\"btn-blue mt-2 w-full sm:w-1/2 md:w-1/3\"\r\n              :disabled=\"saving\"\r\n          >\r\n            {{ saving ? 'Saving...' : 'Save Mobile Number' }}\r\n          </button>\r\n        </div>\r\n\r\n      </div>\r\n    </div>\r\n  </form>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { ref, onMounted } from 'vue'\r\nimport { useRuntimeConfig, useSanctumFetch, useSanctum } from '#imports'\r\nimport { useToast } from '#imports'\r\n\r\nconst toast = useToast()\r\nconst config = useRuntimeConfig()\r\nconst { user, refreshUser } = useSanctum()\r\n\r\nconst mobile = ref('')\r\nconst otp = ref(['', '', '', '', '', ''])\r\nconst otpSent = ref(false)\r\nconst otpVerified = ref(false)\r\nconst otpSending = ref(false)\r\nconst verifyingOtp = ref(false)\r\nconst saving = ref(false)\r\nconst countdown = ref(60)\r\nlet countdownInterval: any = null\r\nconst fieldError = ref('')\r\nconst otpError = ref('')\r\nconst canSendOtp = ref(false)\r\nlet originalMobile = ''\r\n\r\nonMounted(() => {\r\n  if (user.value?.mobile) {\r\n    mobile.value = user.value.mobile\r\n    originalMobile = user.value.mobile\r\n  }\r\n})\r\n\r\nasync function onMobileBlur() {\r\n  const value = mobile.value.trim()\r\n  if (value === originalMobile) {\r\n    otpSent.value = false\r\n    otpVerified.value = false\r\n    otpError.value = ''\r\n    canSendOtp.value = false\r\n    return\r\n  }\r\n\r\n  const regex = /^[6-9]\\d{9}$/\r\n  if (!regex.test(value)) {\r\n    fieldError.value = 'Enter a valid 10-digit Indian mobile number'\r\n    canSendOtp.value = false\r\n    return\r\n  }\r\n\r\n  fieldError.value = ''\r\n  otpSent.value = false\r\n  otpVerified.value = false\r\n  otpError.value = ''\r\n\r\n  try {\r\n    const res = await useSanctumFetch(`${config.public.apiBase}/auth/has_contact`, {\r\n      method: 'POST',\r\n      body: { type: 'mobile', value },\r\n    })\r\n    canSendOtp.value = !res.data.exists\r\n    if (res.data.exists) fieldError.value = 'Mobile number already in use'\r\n  } catch {\r\n    fieldError.value = 'Failed to check mobile'\r\n    canSendOtp.value = false\r\n  }\r\n}\r\n\r\nfunction focusNext(index: number, event: any) {\r\n  if (event.inputType !== 'deleteContentBackward') {\r\n    const next = event.target.nextElementSibling\r\n    if (next) next.focus()\r\n  }\r\n}\r\n\r\nasync function sendOtp() {\r\n  otpError.value = ''\r\n  otpVerified.value = false\r\n  otpSending.value = true\r\n  try {\r\n    await useSanctumFetch(`${config.public.apiBase}/auth/send-otp`, {\r\n      method: 'POST',\r\n      body: { type: 'mobile', value: mobile.value.trim() },\r\n    })\r\n    otpSent.value = true\r\n    canSendOtp.value = false\r\n    countdown.value = 60\r\n    countdownInterval = setInterval(() => {\r\n      countdown.value--\r\n      if (countdown.value <= 0) {\r\n        clearInterval(countdownInterval)\r\n        canSendOtp.value = true\r\n        otpSending.value = false\r\n      }\r\n    }, 1000)\r\n    toast.info({ title: 'OTP Sent', message: 'A 6-digit OTP has been sent to your mobile.' })\r\n  } catch (err: any) {\r\n    otpError.value = err?.data?.message || 'Failed to send OTP'\r\n    otpSending.value = false\r\n    toast.error({ title: 'Error', message: otpError.value })\r\n  }\r\n}\r\n\r\nasync function verifyOtp() {\r\n  const code = otp.value.join('')\r\n  if (code.length !== 6) {\r\n    otpError.value = 'Enter 6-digit OTP'\r\n    return\r\n  }\r\n\r\n  verifyingOtp.value = true\r\n  otpError.value = ''\r\n  try {\r\n    const res = await useSanctumFetch(`${config.public.apiBase}/auth/verify-otp`, {\r\n      method: 'POST',\r\n      body: { type: 'mobile', value: mobile.value.trim(), otp: code },\r\n    })\r\n    otpVerified.value = res.data?.valid === true\r\n    if (!otpVerified.value) otpError.value = 'Invalid OTP, please try again'\r\n    if (otpVerified.value) otpSent.value = false\r\n  } catch (err: any) {\r\n    otpError.value = err?.data?.message || 'OTP verification failed'\r\n  } finally {\r\n    verifyingOtp.value = false\r\n  }\r\n}\r\n\r\nasync function saveMobile() {\r\n  if (!otpVerified.value) return\r\n  saving.value = true\r\n  try {\r\n    await useSanctumFetch(`${config.public.apiBase}/account/contact`, {\r\n      method: 'PUT',\r\n      body: {\r\n        mobile: mobile.value.trim(),\r\n        type: 'mobile',\r\n        otp: otp.value.join(''), // ✅ send OTP along with mobile\r\n      },\r\n    })\r\n    toast.success({ title: 'Success!', message: 'Mobile number updated successfully.' })\r\n    otpVerified.value = false\r\n    otp.value = ['', '', '', '', '', '']\r\n    originalMobile = mobile.value.trim()\r\n    canSendOtp.value = false\r\n    refreshUser()\r\n  } catch (err: any) {\r\n    toast.error({ title: 'Error!', message: err?.data?.message || 'Failed to update mobile' })\r\n  } finally {\r\n    saving.value = false\r\n  }\r\n}\r\n\r\n</script>\r\n\r\n<style scoped>\r\n.input-field {\r\n  @apply w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600\r\n  text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 rounded-md;\r\n}\r\n\r\n.otp-input {\r\n  @apply w-12 sm:w-10 md:w-16 h-12 sm:h-10 md:h-16 text-center rounded border border-gray-300 dark:border-gray-600\r\n  bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500;\r\n}\r\n.form-label {\r\n  @apply block text-sm font-medium text-gray-700 dark:text-gray-300;\r\n}\r\n.btn-blue {\r\n  @apply bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition;\r\n}\r\n.btn-green {\r\n  @apply bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition;\r\n}\r\n.form-error {\r\n  @apply text-sm text-red-600 dark:text-red-400 mt-1 block text-center;\r\n}\r\n</style>\r\n"],"names":["toast","useToast","config","useRuntimeConfig","user","refreshUser","useSanctum","mobile","ref","otp","otpSent","otpVerified","otpSending","verifyingOtp","saving","countdown","countdownInterval","fieldError","otpError","canSendOtp","originalMobile","onMounted","_a","onMobileBlur","value","res","useSanctumFetch","focusNext","index","event","next","sendOtp","setInterval","err","verifyOtp","code","_b","saveMobile","_createElementBlock","_createElementVNode","_hoisted_1","_hoisted_2","_hoisted_3","_cache","$event","_hoisted_4","_toDisplayString","_openBlock","_hoisted_5","_hoisted_6","_hoisted_7","_hoisted_8","_Fragment","_renderList","digit","_vModelText","_hoisted_10","_hoisted_11","_hoisted_12","_hoisted_13"],"mappings":"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"}